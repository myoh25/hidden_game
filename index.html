<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>😎퍼즐 고수를 위한 도전</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- 고운바탕 폰트 -->
  <link href="https://fonts.googleapis.com/css2?family=Gowun+Batang&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Gowun Batang', serif; background: linear-gradient(135deg, #ffe4e1, #fff0f5); display: flex; flex-direction: column; align-items: center; padding: 1rem; margin: 0; }
    h1 { margin-bottom: 1rem; color: #d57fa8; font-size: 1.8rem; }
    #modeSelect { text-align: center; margin-bottom: 1rem; }
    .mode-label { font-size: 1.1rem; color: #743388; margin-bottom: .5rem; }
    .mode-btn { padding: .6rem 1rem; background: #f8bebe; color: #fff; border: none; border-radius: 20px; cursor: pointer; margin: 0 .25rem; transition: transform .2s; display: inline-block; }
    .mode-btn.selected { background: IndianRed; transform: scale(1.05); }
    #startBtn, #shuffleBtn { padding: .8rem 1.6rem; background: #d57fa8; color: #fff; border: none; border-radius: 24px; cursor: pointer; margin: .5rem auto; display: block; transition: transform .2s; }
    #startBtn:hover, #shuffleBtn:hover { transform: scale(1.05); }
    #justGuestbookBtn { padding: .6rem 1rem; background: #000; color: #fff; border: none; border-radius: 20px; cursor: pointer; margin-top: 1rem; display: block; }
    #puzzleCanvas { width: 100%; max-width: 360px; aspect-ratio: 1/1; border: 4px solid #f8c8dc; border-radius: 12px; background: #fff; }
    #timer { margin: .8rem 0; font-size: 1.4rem; color: #d57fa8; font-weight:700; }
    #message { margin: 1rem 0; font-size:1.2rem; color: #d57fa8; font-weight:700; }
    section { width:100%; max-width:360px; margin-top:1.5rem; background:#fff; border-radius:12px; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,0.05); }
    section h2 { font-size:1.2rem; color:#d57fa8; text-align:center; margin-bottom:.5rem; }
    #guestbookList p { display:flex; justify-content:space-between; margin:.6rem 0; }
    .deleteBtn { background:transparent; border:none; color:#e07090; cursor:pointer; }
    #rankingTable { width:100%; border-collapse:collapse; }
    #rankingTable th, #rankingTable td { border:1px solid #eee; padding:.6rem; text-align:center; }
    .modal { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(255,255,255,0.9); display:none; justify-content:center; align-items:center; z-index:1000; }
    .modal-content { background:#fff; padding:1rem; border-radius:12px; display:flex; flex-direction:column; gap:.5rem; width:80%; max-width:320px; }
    .modal-content input, .modal-content textarea, .modal-content button { font-family:'Gowun Batang', serif; }
    .modal-close { background:#ccc !important; }
  </style>
</head>
<body>
  <h1>퍼즐 고수를 위한 도전</h1>
  <div id="modeSelect">
    <div class="mode-label">난이도를 선택한 후 시작하기를 눌러주세요😗</div>
    <button class="mode-btn selected" id="mode4Btn">고수 (4×4)</button>
    <button class="mode-btn" id="mode5Btn">초고수 (5×5)</button>
  </div>
  <button id="startBtn">시작하기</button>
  <div id="timer">00:00.00</div>
  <canvas id="puzzleCanvas"></canvas>
  <button id="shuffleBtn">다시 섞기</button>
  <button id="justGuestbookBtn">😫그냥 방명록만 쓸래요</button>
  <section id="guestbookSection">
    <h2>방명록</h2>
    <div id="guestbookList"></div>
  </section>
  <section id="rankingSection">
    <h2>랭킹 리스트</h2>
    <table id="rankingTable"><thead><tr><th>순위</th><th>이름</th><th>기록(초)</th></tr></thead><tbody></tbody></table>
  </section>
  <button id="devBtn">개발자 도구</button>
  <div id="guestbookModal" class="modal">
    <div class="modal-content">
      <h3>방명록 작성</h3>
      <input type="text" id="gbName" placeholder="이름 (최대 10자)" maxlength="10">
      <textarea id="gbMsg" placeholder="메시지 (15자)" maxlength="15"></textarea>
      <button id="gbSubmit">등록</button>
      <button id="gbCancel" class="modal-close">취소</button>
    </div>
  </div>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwiaJZx-i7jleHhLLPLgsBOvT308q0iTvgUamNwL6K47fwhiaEszitRW49TOGA6u1He/exec';
    let entries = [];
    let bypassRanking = false;
    // DOM ready: fetch shared entries
    document.addEventListener('DOMContentLoaded', () => {
      resizeCanvas(); adjustStartWidth(); draw();
      fetchEntries();
    });

    async function fetchEntries() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        entries = data;
        renderGuestbook(); renderRanking();
      } catch (e) { console.error(e); }
    }

    async function postEntry(entry) {
      try {
        await fetch(API_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(entry)
        });
        await fetchEntries();
      } catch(e) { console.error(e); }
    }

    // Puzzle logic
    const img = new Image(); img.src = 'https://cdn.jsdelivr.net/gh/myoh25/1/puzzle-hidden.jpg';
    let puzzleSize = 4; const mode4Btn = document.getElementById('mode4Btn'), mode5Btn = document.getElementById('mode5Btn');
    const startBtn = document.getElementById('startBtn'), shuffleBtn = document.getElementById('shuffleBtn');
    const justBtn = document.getElementById('justGuestbookBtn'), devBtn = document.getElementById('devBtn');
    const canvas = document.getElementById('puzzleCanvas'), ctx = canvas.getContext('2d');
    let tiles, emptyPos, timerInterval, startTime;
    function adjustStartWidth() { startBtn.style.width = document.getElementById('modeSelect').offsetWidth + 'px'; }
    function resizeCanvas() { const w=canvas.clientWidth; canvas.width=w; canvas.height=w; }
    window.addEventListener('resize',()=>{ resizeCanvas(); adjustStartWidth(); draw(); });
    mode4Btn.onclick=()=>{ puzzleSize=4; mode4Btn.classList.add('selected'); mode5Btn.classList.remove('selected'); adjustStartWidth(); };
    mode5Btn.onclick=()=>{ puzzleSize=5; mode5Btn.classList.add('selected'); mode4Btn.classList.remove('selected'); adjustStartWidth(); };
    startBtn.onclick=startGame;
    shuffleBtn.onclick=()=>{ initGame(); draw(); };
    justBtn.onclick=()=>{ bypassRanking=true; showGuestbookModal(); };
    devBtn.onclick=openDevPrompt;
    function initGame(){ tiles=[]; emptyPos={r:puzzleSize-1,c:puzzleSize-1}; for(let r=0;r<puzzleSize;r++){ tiles[r]=[]; for(let c=0;c<puzzleSize;c++) tiles[r][c]={r,c}; } tiles[puzzleSize-1][puzzleSize-1]=null; shuffle(); }
    function shuffle(){ const dirs=[{r:-1,c:0},{r:1,c:0},{r:0,c:-1},{r:0,c:1}]; for(let i=0;i<1000;i++){ const moves=dirs.map(d=>({r:emptyPos.r+d.r,c:emptyPos.c+d.c})).filter(p=>p.r>=0&&p.r<puzzleSize&&p.c>=0&&p.c<puzzleSize); moveTile(...Object.values(moves[Math.floor(Math.random()*moves.length)])); }}
    function moveTile(r,c){ if((Math.abs(r-emptyPos.r)===1&&c===emptyPos.c)||(Math.abs(c-emptyPos.c)===1&&r===emptyPos.r)){ tiles[emptyPos.r][emptyPos.c]=tiles[r][c]; tiles[r][c]=null; emptyPos={r,c}; }}
    function draw(){ const w=canvas.width/puzzleSize; ctx.clearRect(0,0,canvas.width,canvas.height); for(let r=0;r<puzzleSize;r++)for(let c=0;c<puzzleSize;c++){ const t=tiles[r][c]; if(t){ ctx.drawImage(img,t.c*img.width/puzzleSize,t.r*img.height/puzzleSize,img.width/puzzleSize,img.height/puzzleSize,c*w,r*w,w,w); ctx.strokeStyle='#f8c8dc';ctx.lineWidth=2;ctx.strokeRect(c*w+1,r*w+1,w-2,w-2); } }}
    canvas.addEventListener('click',e=>{ const rect=canvas.getBoundingClientRect(), w=canvas.width/puzzleSize; const c=Math.floor((e.clientX-rect.left)/w), r=Math.floor((e.clientY-rect.top)/w); moveTile(r,c); draw(); if(checkComplete()) onComplete(); });
    function checkComplete(){ return tiles.every((row,r)=>row.every((t,c)=>t?t.r===r&&t.c===c:true)); }
    function startGame(){ initGame(); draw(); startTime=Date.now(); clearInterval(timerInterval); timerInterval=setInterval(()=>{ document.getElementById('timer').textContent=((Date.now()-startTime)/1000).toFixed(2)+' 초';},100); document.getElementById('message').textContent=''; }
    function onComplete(){ clearInterval(timerInterval); document.getElementById('message').textContent='🎉 완벽해요! 방명록을 남기고 기록을 자랑해보세요 🎉'; showGuestbookModal(); }
    function openDevPrompt(){ const code=prompt('개발자 코드 입력'); if(code==='0827'){ initGame(); draw(); onComplete(); } else alert('코드가 틀렸습니다'); }
    const modal=document.getElementById('guestbookModal'); document.getElementById('gbCancel').onclick=()=>modal.style.display='none'; document.getElementById('gbSubmit').onclick=()=>{
      const name=document.getElementById('gbName').value.trim(); let msg=document.getElementById('gbMsg').value.trim(); if(!name||!msg) return; msg=msg.substring(0,15);
      const record=((Date.now()-startTime)/1000).toFixed(2);
      postEntry({ name, msg, record, skip: bypassRanking }); bypassRanking=false;
      modal.style.display='none';
    };
    function showGuestbookModal(){ modal.style.display='flex'; }
    function renderGuestbook(){ const ctr=document.getElementById('guestbookList'); ctr.innerHTML=''; entries.sort((a,b)=>new Date(a.time)-new Date(b.time)).forEach(e=>{ const p=document.createElement('p'); p.innerHTML=`<span>${new Date(e.time).toLocaleString()} | ${e.name}: ${e.msg}</span> <button class='deleteBtn' data-id='${e.id}'>삭제</button>`; ctr.append(p); }); document.querySelectorAll('.deleteBtn').forEach(btn=>btn.onclick=async()=>{ const code=prompt('삭제 코드 입력'); if(code!=='0827'){alert('코드가 틀렸습니다');return;} await postEntry({ id:btn.dataset.id, delete:true }); }); }
    function renderRanking(){ const tbody=document.querySelector('#rankingTable tbody'); tbody.innerHTML=''; entries.filter(e=>!e.skip).sort((a,b)=>e.record-b.record).forEach((e,i)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${e.name}</td><td>${e.record}</td>`; tbody.append(tr); }); }
  </script>
</body>
</html>
